{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["/* global Ractive */\n\nvar template = `<div class=\"ractive-autocomplete\"><input value=\"{{text}}\" on-blur=\"blurred()\" on-dblclick=\"popup()\" on-keydown=\"keydown\" {{#if .placeholder}}placeholder=\"{{.placeholder}}\"{{/if}} /><div on-click=\"clicked\">\n{{#popup}}\n<ul>{{#completions:i}}<li {{#isCurrent(i)}}class=\"current\"{{/}}>{{display(.)}}</li>{{/}}</ul>\n{{/}}</div></div>`;\n\nfunction isCurrent(idx) { return this.get('current') === idx; }\nfunction display(member) {\n  return this.display(member);\n}\n\nexport default Ractive.extend({\n  template: template,\n  lazy: 500,\n  isolated: true,\n  oninit() {\n    this.observe('text', (cur, prev) => {\n      // only do completion lookup if this is not from a `select`\n      if (cur !== this.get('currentText')) {\n        // reset current index\n        this.set('current', -1);\n\n        // get new completions\n        var fn = this.get('complete');\n        if (fn && typeof fn === 'function') {\n          var res = fn(cur);\n          if (Object.prototype.toString.call(res) === '[object Array]') {\n            this.set('completions', res);\n            this.popup();\n          }\n          else if (res.then && typeof res.then === 'function') res.then(arr => {\n            this.set('completions', arr);\n            this.popup();\n          });\n        }\n      }\n    }, { init: false });\n  },\n  onrender() {\n    var cpl, val;\n\n    this.on('clicked', (e) => {\n      var i, child, ul = this.find('ul'), found = -1;\n      for (i = 0; i < ul.children.length && (child = ul.children[i]); i++) {\n        if (child === e.original.target) {\n          found = i;\n          break;\n        }\n      }\n      this.select(found);\n    });\n\n    this.on('keydown', (e) => {\n      var k = e.original.keyCode;\n      if (k === 27) {\n        this.closePopup();\n      } else if (k === 38 || k === 40) {\n        e.original.preventDefault();\n        if (!this.get('popup')) return this.popup();\n        var c = this.get('current');\n        this.select(k === 38 ? c - 1 : c + 1, false);\n      } else if (k === 13) {\n        e.original.preventDefault();\n        this.closePopup();\n        this.select(this.get('current'));\n      }\n    });\n\n    if ((cpl = this.get('completeWith')) && typeof cpl === 'function') {\n      this.completeWith(cpl);\n    }\n\n    // if there are no completions but there is a value, use it and select it\n    if (!!(cpl = this.get('completions')) && (val = this.get('value'))) {\n      this.set('completions', [val]);\n      this.select(0, false);\n    }\n  },\n  data() {\n    return {\n      isCurrent,\n      display,\n      completions: [],\n      current: -2,\n      popup: false,\n      currentText: '',\n      currentVal: '',\n      text: ''\n    };\n  },\n  blurred() {\n    if (this.blurTime) {\n      clearTimeout(this.blurTime);\n    }\n\n    this.blurTime = setTimeout(() => this.closePopup(), 200);\n  },\n  closePopup() { this.set('popup', false); },\n  popup() { this.set('popup', true); },\n  display(member) {\n    var name = this.get('displayMember');\n    if (typeof name === 'string') {\n      return member ? member[name] : '';\n    } else if (typeof name === 'function') {\n      return member ? name(member) : '';\n    } else {\n      return member ? member : '';\n    }\n  },\n  select(idx, fin = true) {\n    var val = this.get('completions') || [];\n    var text = '';\n\n    if (idx === -1) idx = val.length - 1;\n    else if (idx === val.length) idx = 0;\n\n    if (val) val = val[idx];\n    text = this.display(val);\n\n    // update current selections\n    this.set({\n      currentText: text,\n      currentVal: val\n    });\n\n    // update input and highlight\n    this.set({\n      text: text,\n      current: idx\n    });\n\n    if (fin) {\n      this.closePopup();\n      this.set('value', val);\n      this.fire('complete', text, idx, val);\n    }\n  },\n  completeWith(fn) {\n    this.set('complete', fn);\n    this.updateModel('text');\n  }\n});\n"],"names":[],"mappings":"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"}